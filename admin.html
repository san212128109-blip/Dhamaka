<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dhamaka Admin Panel</title>
<style>
body{font-family:Arial,sans-serif;background:#f0f2f5;color:#333;margin:0;padding:0;}
header{background:#28a745;color:white;padding:1em;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;}
nav a{margin-left:1em;color:white;text-decoration:none;font-weight:bold;}
.container{padding:1em;}
table{width:100%;border-collapse:collapse;margin-top:1em;}
th,td{border:1px solid #ccc;padding:0.5em;text-align:center;}
button{padding:0.5em 1em;margin:0.3em;border:none;border-radius:5px;cursor:pointer;}
button.edit{background:#007bff;color:white;}
button.delete{background:#dc3545;color:white;}
button.approve{background:#28a745;color:white;}
button.reject{background:#ffc107;color:black;}
input,select{padding:0.4em;margin:0.3em;border-radius:4px;border:1px solid #ccc;}
h2{margin-top:1em;text-align:center;}
section{margin-top:2em;padding:1em;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.form-group input, .form-group select {width: 200px; display: inline-block;}
.form-group {margin-bottom: 10px; display: flex; align-items: center; gap: 10px;}
</style>
</head>
<body>

<header>
<h1>Admin Panel</h1>
<div>
  <a href="index.html" target="_blank" style="margin-right: 15px; color: #ffc107;">View Shop</a>
  <button onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<section>
<h2>Vendor Approvals & Management</h2>
<table id="vendorTable">
<thead>
<tr>
<th>ID</th><th>Name</th><th>Status</th><th>Promocode</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section>
<h2>Product Approvals & Management</h2>
<table id="productTable">
<thead>
<tr>
<th>Status</th><th>Name</th><th>Vendor</th><th>Price</th><th>Stock</th><th>Category</th><th>Assigned Promo</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section>
<h2>Promocode Management</h2>
<div id="promoForm">
    <h3>Add/Edit Promocode</h3>
    <input type="hidden" id="editPromoCode">
    <div class="form-group">
        <label>Code:</label><input type="text" id="promoCode" placeholder="E.g., SALE20">
        <label>Discount:</label><input type="number" id="promoDiscount" placeholder="Value (e.g., 20)">
        <label>Type:</label>
        <select id="promoType">
            <option value="percent">Percentage (%)</option>
            <option value="fixed">Fixed Amount ($)</option>
        </select>
        <label>Min. Order:</label><input type="number" id="promoMinOrder" value="0" min="0">
    </div>
    <button class="approve" onclick="savePromocode()">Save Promocode</button>
    <button class="reject" onclick="resetPromoForm()">Cancel</button>
</div>

<table id="promocodeTable">
<thead>
<tr>
<th>Code</th><th>Discount</th><th>Type</th><th>Min. Order</th><th>Scope</th><th>Usage Count</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section>
<h2>Banner Management (Carousel)</h2>
<div id="bannerForm">
    <h3>Add/Edit Banner</h3>
    <input type="hidden" id="editBannerId">
    <div class="form-group">
        <label>Image URL:</label><input type="url" id="bannerImageURL" placeholder="Image URL">
        <label>Link URL:</label><input type="url" id="bannerLinkURL" placeholder="Link (e.g., #categories)">
    </div>
    <button class="approve" onclick="saveBanner()">Save Banner</button>
</div>

<table id="bannerTable">
<thead>
<tr>
<th>Preview</th><th>Image URL</th><th>Link URL</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section>
<h2>Order Management</h2>
<table id="orderTable">
<thead>
<tr>
<th>Order ID</th><th>Customer</th><th>Total</th><th>Promocode</th><th>Status</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

<section>
<h2>Customers</h2>
<table id="customerTable">
<thead>
<tr>
<th>Username</th><th>WhatsApp</th><th>Address</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</section>

</div>

<script>
// ======= ADMIN CREDENTIALS (for prompt login) =======
const ADMIN_CRED = {id:"Nafis",password:"nafis128"};

// ======= DATA LOAD =======
let vendors = JSON.parse(localStorage.getItem("vendors")||'[]');
let customers = JSON.parse(localStorage.getItem("customers")||'[]');
let products = JSON.parse(localStorage.getItem("products")||'[]');
let orders = JSON.parse(localStorage.getItem("orders")||'[]');
let masterPromocodes = JSON.parse(localStorage.getItem("masterPromocodes")||'[]');
let banners = JSON.parse(localStorage.getItem("banners")||'[]');
let promocodeUsage = JSON.parse(localStorage.getItem("promocodeUsage")||'{}');


// ======= ADMIN LOGIN CHECK =======
let loggedAdmin = JSON.parse(localStorage.getItem("loggedAdmin")||'null');
if(!loggedAdmin){
  let username = prompt("Enter Admin ID:", ADMIN_CRED.id);
  let password = prompt("Enter Admin Password:", ADMIN_CRED.password);
  if(username===ADMIN_CRED.id && password===ADMIN_CRED.password){
    loggedAdmin = ADMIN_CRED;
    localStorage.setItem("loggedAdmin",JSON.stringify(loggedAdmin));
  } else { alert("Invalid Admin Credentials! Redirecting to shop."); window.location.href="index.html"; }
}

// ======= LOGOUT =======
function logout(){
  localStorage.removeItem("loggedAdmin");
  alert("Admin logged out");
  window.location.href="index.html";
}

// ======= UTILITIES =======
function saveAllData(){
  localStorage.setItem("vendors",JSON.stringify(vendors));
  localStorage.setItem("customers",JSON.stringify(customers));
  localStorage.setItem("products",JSON.stringify(products));
  localStorage.setItem("orders",JSON.stringify(orders));
  localStorage.setItem("masterPromocodes",JSON.stringify(masterPromocodes));
  localStorage.setItem("banners",JSON.stringify(banners));
}

function getVendorName(vendorId){
  return vendors.find(v=>v.id===vendorId)?.name || "Unknown Vendor";
}

// ======= VENDOR TABLE =======
function renderVendors(){
  const tbody = document.querySelector("#vendorTable tbody");
  tbody.innerHTML="";
  vendors.forEach((v,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${v.id}</td>
      <td>${v.name} (${v.whatsapp})</td>
      <td><span style="font-weight:bold; color:${v.status==='Approved'?'#28a745':'#ffc107'}">${v.status}</span></td>
      <td>${v.promocode}</td>
      <td>
        ${v.status!=='Approved'?`<button class="approve" onclick="approveVendor(${i})">Approve</button>`:""}
        ${v.status!=='Rejected'?`<button class="reject" onclick="rejectVendor(${i})">Reject</button>`:""}
        <button class="delete" onclick="deleteVendor(${i})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function approveVendor(i){
  vendors[i].status="Approved";
  saveAllData();
  renderVendors();
}

function rejectVendor(i){
  vendors[i].status="Rejected";
  saveAllData();
  renderVendors();
}

function deleteVendor(i){
  if(confirm(`Delete vendor ${vendors[i].name}? This will NOT delete their products.`)){
    vendors.splice(i,1);
    saveAllData();
    renderVendors();
  }
}


// ======= PRODUCT TABLE =======
function renderProductsTable(){
  const tbody = document.querySelector("#productTable tbody");
  tbody.innerHTML="";
  products.forEach((p,i)=>{
    const vendorName = getVendorName(p.vendorId);
    const tr=document.createElement("tr");
    const statusColor = p.status === 'Approved' ? '#28a745' : (p.status === 'Rejected' ? '#dc3545' : 'orange');

    tr.innerHTML=`
      <td><span style="font-weight:bold; color:${statusColor}">${p.status}</span></td>
      <td>${p.name}</td>
      <td>${vendorName}</td>
      <td>$${p.price.toFixed(2)}</td>
      <td>${p.stock}</td>
      <td>${p.category}</td>
      <td>${p.promoCodeAssigned || 'None'}</td>
      <td>
        ${p.status!=='Approved'?`<button class="approve" onclick="approveProduct(${i})">Approve</button>`:""}
        ${p.status!=='Rejected'?`<button class="reject" onclick="rejectProduct(${i})">Reject</button>`:""}
        <button class="delete" onclick="deleteProduct(${i})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function approveProduct(i){
  products[i].status="Approved";
  saveAllData();
  renderProductsTable();
}

function rejectProduct(i){
  products[i].status="Rejected";
  saveAllData();
  renderProductsTable();
}

function deleteProduct(i){
  if(confirm(`Delete product ${products[i].name}?`)){
    products.splice(i,1);
    saveAllData();
    renderProductsTable();
  }
}

// ======= PROMOCODE MANAGEMENT =======

function resetPromoForm() {
  document.getElementById('editPromoCode').value = '';
  document.getElementById('promoCode').value = '';
  document.getElementById('promoDiscount').value = '';
  document.getElementById('promoType').value = 'percent';
  document.getElementById('promoMinOrder').value = 0;
}

function savePromocode(){
  const code = document.getElementById('promoCode').value.trim().toUpperCase();
  const discount = parseFloat(document.getElementById('promoDiscount').value);
  const type = document.getElementById('promoType').value;
  const minOrder = parseFloat(document.getElementById('promoMinOrder').value);
  const editCode = document.getElementById('editPromoCode').value;

  if (!code || isNaN(discount) || discount <= 0 || isNaN(minOrder) || minOrder < 0) {
    alert("Fill all fields correctly.");
    return;
  }

  const newPromo = {
    code,
    discount,
    type,
    minOrder,
    scope: 'global', // Admin created promos are global
    expiry: '2026-12-31' // Default expiry
  };

  if (editCode) {
    // Update existing
    const index = masterPromocodes.findIndex(p => p.code === editCode);
    if (index !== -1) {
      masterPromocodes[index] = { ...masterPromocodes[index], ...newPromo };
    }
  } else {
    // Add new
    if (masterPromocodes.some(p => p.code === code)) {
      alert("Promocode already exists.");
      return;
    }
    masterPromocodes.push(newPromo);
  }

  saveAllData();
  renderPromocodes();
  resetPromoForm();
}

function editPromocode(code){
  const promo = masterPromocodes.find(p => p.code === code);
  if (promo && promo.scope === 'global') {
    document.getElementById('editPromoCode').value = promo.code;
    document.getElementById('promoCode').value = promo.code;
    document.getElementById('promoDiscount').value = promo.discount;
    document.getElementById('promoType').value = promo.type;
    document.getElementById('promoMinOrder').value = promo.minOrder;
  } else if (promo && promo.scope === 'vendor') {
    alert("Vendor-specific promo codes cannot be edited by Admin here.");
  }
}

function deletePromocode(code){
  if(confirm(`Delete promocode ${code}?`)){
    masterPromocodes = masterPromocodes.filter(p => p.code !== code);
    saveAllData();
    renderPromocodes();
  }
}


function renderPromocodes(){
  const tbody = document.querySelector("#promocodeTable tbody");
  tbody.innerHTML="";
  masterPromocodes.forEach(p=>{
    const usageCount = promocodeUsage[p.code] || 0;
    const tr=document.createElement("tr");
    const scopeInfo = p.scope === 'vendor' ? `Vendor: ${p.vendorId}` : 'Global';
    tr.innerHTML=`
      <td>${p.code}</td>
      <td>${p.discount} ${p.type === 'percent' ? '%' : '$ Fixed'}</td>
      <td>$${p.minOrder.toFixed(2)}</td>
      <td>${scopeInfo}</td>
      <td>${usageCount}</td>
      <td>
        <button class="edit" onclick="editPromocode('${p.code}')" ${p.scope === 'vendor' ? 'disabled' : ''}>Edit</button>
        <button class="delete" onclick="deletePromocode('${p.code}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ======= BANNER MANAGEMENT =======

function saveBanner(){
  const imageURL = document.getElementById('bannerImageURL').value.trim();
  const linkURL = document.getElementById('bannerLinkURL').value.trim();
  const editId = parseInt(document.getElementById('editBannerId').value);

  if (!imageURL) {
    alert("Image URL is required.");
    return;
  }

  if (editId) {
    // Update existing
    const index = banners.findIndex(b => b.id === editId);
    if (index !== -1) {
      banners[index].imageURL = imageURL;
      banners[index].link = linkURL || '#';
    }
  } else {
    // Add new
    const newId = banners.length > 0 ? Math.max(...banners.map(b => b.id)) + 1 : 1;
    banners.push({ id: newId, imageURL, link: linkURL || '#' });
  }

  saveAllData();
  renderBanners();
  document.getElementById('editBannerId').value = '';
  document.getElementById('bannerImageURL').value = '';
  document.getElementById('bannerLinkURL').value = '';
}

function editBanner(id){
  const banner = banners.find(b => b.id === id);
  if (banner) {
    document.getElementById('editBannerId').value = banner.id;
    document.getElementById('bannerImageURL').value = banner.imageURL;
    document.getElementById('bannerLinkURL').value = banner.link;
  }
}

function deleteBanner(id){
  if(confirm(`Delete banner ${id}?`)){
    banners = banners.filter(b => b.id !== id);
    saveAllData();
    renderBanners();
  }
}

function renderBanners(){
  const tbody = document.querySelector("#bannerTable tbody");
  tbody.innerHTML="";
  banners.forEach(b=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><img src="${b.imageURL}" style="width:100px; height:50px; object-fit:cover;"></td>
      <td>${b.imageURL}</td>
      <td><a href="${b.link}" target="_blank">${b.link}</a></td>
      <td>
        <button class="edit" onclick="editBanner(${b.id})">Edit</button>
        <button class="delete" onclick="deleteBanner(${b.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}


// ======= ORDER TABLE =======
function renderOrders(){
  const tbody = document.querySelector("#orderTable tbody");
  tbody.innerHTML="";
  orders.forEach((o,i)=>{
    const statusColor = o.status === 'Completed' ? '#28a745' : (o.status === 'Cancelled' ? '#dc3545' : 'orange');

    tr=document.createElement("tr");
    tr.innerHTML=`
      <td>#${o.id} (${o.date ? new Date(o.date).toLocaleDateString() : 'N/A'})</td>
      <td>${o.customer}</td>
      <td>$${o.total}</td>
      <td>${o.promocode}</td>
      <td><span style="font-weight:bold; color:${statusColor}">${o.status}</span></td>
      <td>
        <select onchange="updateOrderStatus(${i},this.value)">
          <option value="Pending" ${o.status==="Pending"?"selected":""}>Pending</option>
          <option value="Completed" ${o.status==="Completed"?"selected":""}>Completed</option>
          <option value="Cancelled" ${o.status==="Cancelled"?"selected":""}>Cancelled</option>
        </select>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function updateOrderStatus(i,status){
  orders[i].status=status;
  saveAllData();
  renderOrders();
}


// ======= CUSTOMER TABLE =======
function renderCustomers(){
  const tbody = document.querySelector("#customerTable tbody");
  tbody.innerHTML="";
  customers.forEach((c,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${c.username}</td>
      <td>${c.whatsapp}</td>
      <td>${c.address}</td>
      <td><button class="delete" onclick="deleteCustomer(${i})">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function deleteCustomer(i){
  if(confirm(`Delete customer ${customers[i].username}?`)){
    customers.splice(i,1);
    saveAllData();
    renderCustomers();
  }
}


// ======= INITIAL RENDER ALL SECTIONS =======
function initRender() {
  renderVendors();
  renderCustomers();
  renderProductsTable();
  renderOrders();
  renderPromocodes();
  renderBanners();
}

initRender();

</script>
</body>
</html>
