<script>
// ====== INITIALIZE LOCALSTORAGE DATA MODELS (For testing environment) ======
function initializeLocalStorage() {
    if (!localStorage.getItem('vendors')) {
        // Sample Approved Vendor for easy testing (Optional)
        localStorage.setItem('vendors', JSON.stringify([
            { id: 'vendor001', name: 'Test Vendor', whatsapp: '1234567890', password: 'pass', status: 'Approved', promocode: 'VEND001' }
        ]));
    }
    if (!localStorage.getItem('products')) {
        localStorage.setItem('products', JSON.stringify([]));
    }
    // Master Promo Code List (Admin managed)
    if (!localStorage.getItem('masterPromocodes')) {
        localStorage.setItem('masterPromocodes', JSON.stringify([
            { code: 'FLASH10', discount: 10, type: 'percent', scope: 'global', minOrder: 100, expiry: '2026-01-01' },
            { code: 'SAVE25', discount: 25, type: 'percent', scope: 'global', minOrder: 200, expiry: '2026-01-01' },
            // Add the sample vendor's unique code
            { code: 'VEND001', discount: 15, type: 'percent', scope: 'vendor', vendorId: 'vendor001', minOrder: 50, expiry: '2026-12-31'}
        ]));
    }
}
initializeLocalStorage();


// ===== GLOBAL STATE & DATA LOAD (Robust Loading) =====
let vendors = [];
let products = [];
let masterPromocodes = [];
let currentVendor = JSON.parse(localStorage.getItem('currentVendor')||'null');

function loadData() {
    vendors = JSON.parse(localStorage.getItem("vendors")||'[]');
    products = JSON.parse(localStorage.getItem("products")||'[]');
    masterPromocodes = JSON.parse(localStorage.getItem("masterPromocodes")||'[]');
}

// ===== INIT =====
loadData(); // Initial data load

if(currentVendor){ 
    // Re-check if the vendor still exists and is approved before showing dashboard
    const existingVendor = vendors.find(v => v.id === currentVendor.id && v.status === 'Approved');
    if (existingVendor) {
        showPage('dashboard');
    } else {
        // If the vendor was logged in but later rejected/deleted by admin
        logout(); 
    }
} else { 
    showPage('login'); 
}

function showPage(page){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    if(page==='dashboard'){
        if (currentVendor) {
            document.getElementById('vendorName').innerText = currentVendor.name;
            document.getElementById('vendorPromoCode').innerText = currentVendor.promocode;
            populatePromoDropdown(); // à¦ªà§à¦°à§‹à¦®à§‹ à¦•à§‹à¦¡ à¦¡à§à¦°à¦ªà¦¡à¦¾à¦‰à¦¨ à¦²à§‹à¦¡ à¦•à¦°à¦¾
            renderProducts();
        }
    }
    document.getElementById(page+'Page').style.display='block';
}

function showRegister(){ 
    document.getElementById('regMsg').innerText='';
    document.getElementById('regName').value='';
    document.getElementById('regWhatsapp').value='';
    document.getElementById('regPass').value='';
    showPage('register'); 
}

// ðŸ›‘ UPDATED: à¦²à¦—à¦‡à¦¨ à¦ªà§‡à¦œ à¦°à¦¿à¦¸à§‡à¦Ÿ à¦•à¦°à¦¾à¦° à¦¸à¦®à§Ÿ WhatsApp à¦‡à¦¨à¦ªà§à¦Ÿ à¦°à¦¿à¦¸à§‡à¦Ÿ à¦•à¦°à¦¾
function showLogin(){ 
    document.getElementById('msg').innerText='';
    document.getElementById('vendorWhatsappLogin').value=''; 
    document.getElementById('vendorPass').value='';
    showPage('login'); 
}

// ====== AUTH (VENDOR) =====
function vendorRegister(){
    loadData(); // Reload vendors before registering
    let name=document.getElementById('regName').value.trim();
    let whatsapp=document.getElementById('regWhatsapp').value.trim();
    let pass=document.getElementById('regPass').value.trim();
    if(!name || !whatsapp || !pass){ document.getElementById('regMsg').innerText='Fill all fields'; return; }
    
    // Check if WhatsApp is already registered
    if (vendors.some(v => v.whatsapp === whatsapp)) {
        document.getElementById('regMsg').innerText='This WhatsApp number is already registered.'; return;
    }

    let id = 'vendor'+(vendors.length+1).toString().padStart(3, '0'); // Unique ID format
    // Assign a default unique vendor-specific promocode
    let uniquePromoCode = 'VEND'+(vendors.length+1).toString().padStart(3, '0');

    vendors.push({id,name,whatsapp,password:pass,status:'Pending', promocode: uniquePromoCode});
    localStorage.setItem('vendors',JSON.stringify(vendors));

    // Also add the vendor-specific promo code to master list
    masterPromocodes.push({ code: uniquePromoCode, discount: 15, type: 'percent', scope: 'vendor', vendorId: id, minOrder: 50, expiry: '2026-12-31'});
    localStorage.setItem('masterPromocodes',JSON.stringify(masterPromocodes));

    document.getElementById('regMsg').innerText=`Registered! Your Vendor ID is ${id}. Status: Pending admin approval.`;
    resetForm();
    
    // Clear registration fields only
    document.getElementById('regName').value='';
    document.getElementById('regWhatsapp').value='';
    document.getElementById('regPass').value='';
}

// ðŸ›‘ UPDATED: WhatsApp à¦à¦¬à¦‚ Password à¦¦à¦¿à§Ÿà§‡ à¦²à¦—à¦‡à¦¨
function vendorLogin(){
    loadData(); // *** IMPORTANT: Reload data before checking login ***
    // Vendor ID-à¦à¦° à¦¬à¦¦à¦²à§‡ WhatsApp à¦¨à¦®à§à¦¬à¦° à¦¨à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦šà§à¦›à§‡
    let whatsapp=document.getElementById('vendorWhatsappLogin').value.trim(); 
    let pass=document.getElementById('vendorPass').value.trim();
    
    // WhatsApp à¦à¦¬à¦‚ Password à¦à¦° à¦­à¦¿à¦¤à§à¦¤à¦¿à¦¤à§‡ Vendor à¦–à§‹à¦à¦œà¦¾ à¦¹à¦šà§à¦›à§‡
    let v = vendors.find(v => v.whatsapp===whatsapp && v.password===pass); 
    
    document.getElementById('msg').innerText='';
    if(!v){ 
        document.getElementById('msg').innerText='Invalid WhatsApp Number or password'; 
        return; 
    }
    
    // Vendor Status Check
    if(v.status!=='Approved'){ 
        document.getElementById('msg').innerText=`Not approved by admin yet. Current Status: ${v.status}`; 
        return; 
    }
    
    // Login Successful
    currentVendor=v;
    localStorage.setItem('currentVendor',JSON.stringify(v));
    showPage('dashboard');
}

function logout(){ 
    localStorage.removeItem('currentVendor'); 
    currentVendor=null; 
    showPage('login'); 
}

// ====== PROMO CODE UTILITY (Existing Code) =====
function populatePromoDropdown() {
    loadData(); // Ensure we have the latest list
    const select = document.getElementById('prodPromoCode');
    select.innerHTML = '<option value="">No Special Promo</option>';

    // Show only global codes and the vendor's own unique code
    const availablePromos = masterPromocodes.filter(p => p.scope === 'global' || (p.scope === 'vendor' && p.vendorId === currentVendor.id));

    availablePromos.forEach(promo => {
        const option = document.createElement('option');
        option.value = promo.code;
        option.innerText = `${promo.code} (${promo.discount}${promo.type === 'percent' ? '%' : '$'})`;
        select.appendChild(option);
    });
}


// ====== PRODUCTS (CRUD) (Existing Code with minor cleanup) =====
function generateProductId(){
    return products.length>0 ? Math.max(...products.map(p=>p.id))+1 : 1;
}

function resetForm(){
    document.getElementById('prodName').value='';
    document.getElementById('prodCategory').value='';
    document.getElementById('prodPrice').value='';
    document.getElementById('prodStock').value='';
    document.getElementById('prodImageURL').value='';
    document.getElementById('prodPromoCode').value=''; // Resetting promo code dropdown
    
    editingIndex=null;
    document.getElementById('formTitle').innerText='Add Product';
    document.getElementById('addProductBtn').style.display='block';
    document.getElementById('updateProductBtn').style.display='none';
    document.getElementById('cancelEditBtn').style.display='none';
}

function renderProducts(){
    loadData(); // Reload products before rendering
    const tbody=document.querySelector('#productTable tbody');
    tbody.innerHTML='';
    const vendorProducts = products.filter(p=>p.vendorId===currentVendor.id);

    if(vendorProducts.length===0){ tbody.innerHTML='<tr><td colspan="8">No products added</td></tr>'; return; }

    vendorProducts.forEach((p, idx)=>{
        // Find global index for update/delete/edit
        const globalIndex = products.findIndex(pr => pr.id === p.id);
        
        let statusClass = p.status === 'Approved' ? 'status-approved' : 'status-pending';

        let tr=document.createElement('tr');
        tr.innerHTML=`<td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>$${p.price.toFixed(2)}</td>
                    <td>${p.stock}</td>
                    <td><img class='product-img' src='${p.imageURL || 'placeholder.png'}'></td>
                    <td class="${statusClass}">${p.status}</td>
                    <td>${p.promoCodeAssigned || 'None'}</td>
                    <td>
                      <button class="update" onclick="editProduct(${globalIndex})">Edit</button>
                      <button class="delete" onclick="deleteProduct(${globalIndex})">Delete</button>
                    </td>`;
        tbody.appendChild(tr);
    });
}

function addProduct(){
    loadData(); // Reload products before adding
    let name=document.getElementById('prodName').value.trim();
    let category=document.getElementById('prodCategory').value.trim();
    let price=parseFloat(document.getElementById('prodPrice').value);
    let stock=parseInt(document.getElementById('prodStock').value);
    let imageURL=document.getElementById('prodImageURL').value.trim() || 'https://via.placeholder.com/150'; // Default image
    let promoCodeAssigned = document.getElementById('prodPromoCode').value;

    if(!name || !category || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0){ 
        alert("Please fill all fields correctly (Price > 0, Stock >= 0)"); 
        return; 
    }

    products.push({
        id: generateProductId(),
        name,
        category,
        price,
        stock,
        imageURL,
        vendorId: currentVendor.id,
        status:'Pending', // Initial status is Pending
        promoCodeAssigned 
    });

    localStorage.setItem('products',JSON.stringify(products));
    renderProducts(); 
    resetForm();
    alert('Product added successfully. Waiting for admin approval.');
}

let editingIndex = null; // Defined globally to be safe

function editProduct(i){
    loadData(); // Reload products before editing
    editingIndex=i;
    let p=products[i];
    
    // Check if the product belongs to the current vendor
    if(p.vendorId!==currentVendor.id){ alert("Error: Product does not belong to you."); return; }
    
    document.getElementById('prodName').value=p.name;
    document.getElementById('prodCategory').value=p.category;
    document.getElementById('prodPrice').value=p.price;
    document.getElementById('prodStock').value=p.stock;
    document.getElementById('prodImageURL').value=p.imageURL;
    document.getElementById('prodPromoCode').value=p.promoCodeAssigned || ''; 

    document.getElementById('formTitle').innerText=`Edit Product: ${p.name}`;
    document.getElementById('addProductBtn').style.display='none';
    document.getElementById('updateProductBtn').style.display='block';
    document.getElementById('cancelEditBtn').style.display='inline-block';
}

function updateProduct(){
    if(editingIndex===null){ alert("No product selected"); return; }
    
    let name=document.getElementById('prodName').value.trim();
    let category=document.getElementById('prodCategory').value.trim();
    let price=parseFloat(document.getElementById('prodPrice').value);
    let stock=parseInt(document.getElementById('prodStock').value);
    let imageURL=document.getElementById('prodImageURL').value.trim() || 'https://via.placeholder.com/150';
    let promoCodeAssigned = document.getElementById('prodPromoCode').value;

    if(!name || !category || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0){ 
        alert("Please fill all fields correctly (Price > 0, Stock >= 0)"); 
        return; 
    }
    
    let p=products[editingIndex];
    if(p.vendorId!==currentVendor.id){ alert("Security Error: Not your product"); return; }
    
    // Update data and reset status to 'Pending' for re-approval
    p.name=name; 
    p.category=category; 
    p.price=price; 
    p.stock=stock; 
    p.imageURL=imageURL; 
    p.promoCodeAssigned = promoCodeAssigned;
    p.status='Pending'; // Reset status to Pending after modification
    
    localStorage.setItem('products',JSON.stringify(products));
    renderProducts(); 
    resetForm();
    alert(`Product updated. Status reset to Pending for admin review.`);
}

function deleteProduct(i){
    if(products[i].vendorId!==currentVendor.id){ alert("Error: Not your product"); return; }
    if(confirm(`Are you sure you want to delete ${products[i].name}?`)){ 
        products.splice(i,1); 
        localStorage.setItem('products',JSON.stringify(products)); 
        renderProducts(); 
        resetForm(); 
    }
}

// Initial Call to load data and set page
document.addEventListener('DOMContentLoaded', () => {
    // Already handled outside DOMContentLoaded for immediate execution flow control
});

// ðŸ’¡ BONUS: Simple Admin Approval Function for testing
// Console-à¦ à¦à¦‡ à¦«à¦¾à¦‚à¦¶à¦¨à¦Ÿà¦¿ run à¦•à¦°à§‡ Vendor-à¦•à§‡ Approved à¦•à¦°à¦¾ à¦¯à¦¾à¦¬à§‡: approveVendor('vendor002')
function approveVendor(vendorId) {
    loadData();
    const vendorIndex = vendors.findIndex(v => v.id === vendorId);
    if (vendorIndex !== -1) {
        vendors[vendorIndex].status = 'Approved';
        localStorage.setItem('vendors', JSON.stringify(vendors));
        console.log(`Vendor ${vendorId} status set to Approved.`);
        alert(`Vendor ${vendorId} status set to Approved. Try logging in now.`);
        // Reload page or re-render login form if needed
    } else {
        console.error(`Vendor ${vendorId} not found.`);
    }
}
</script>
