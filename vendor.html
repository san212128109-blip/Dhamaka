<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vendor Dashboard - Dhamaka</title>
<style>
body{font-family:Arial,sans-serif;background:#f8f9fa;color:#212529;margin:0;padding:0;}
header{background:#28a745;color:white;padding:1em;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;}
header button{padding:0.5em 1em;border:none;border-radius:5px;background:#ffc107;color:#212529;cursor:pointer;}
.container{padding:1em;}
input,select,textarea{width:100%;padding:0.5em;margin:0.3em 0;border-radius:5px;border:1px solid #ccc;}
button.action-btn{padding:0.5em 1em;margin:0.3em;border:none;border-radius:5px;cursor:pointer; width: 48%;}
button.add{background:#28a745;color:white;}
button.update{background:#007bff;color:white;}
button.delete{background:#dc3545;color:white; width: auto;}
button.cancel{background:#6c757d;color:white;}
table{width:100%;border-collapse:collapse;margin-top:1em;}
table,th,td{border:1px solid #ccc;}
th,td{padding:0.5em;text-align:center;}
.page{display:none;}
img.product-img{width:50px;height:50px;border-radius:5px; object-fit: cover;}
#addProductContainer{max-width:600px;margin:1em auto;padding:1em;border:1px solid #28a745;border-radius:8px;background:#e2f0e6;}
</style>
</head>
<body>

<header>
<h1>Vendor System</h1>
<div id="headerInfo"></div>
</header>

<div class="container">

<div id="loginPage" class="page">
<h2>Vendor Login</h2>
<input type="text" id="vendorId" placeholder="Vendor ID">
<input type="password" id="vendorPass" placeholder="Password">
<button class="add action-btn" onclick="vendorLogin()">Login</button>
<p id="msg" style="color:red;"></p>
<h3>New Vendor? <button onclick="showRegister()">Register</button></h3>
</div>

<div id="registerPage" class="page">
<h2>Vendor Registration</h2>
<input type="text" id="regName" placeholder="Vendor Name">
<input type="text" id="regWhatsapp" placeholder="WhatsApp Number">
<input type="password" id="regPass" placeholder="Password">
<button class="add action-btn" onclick="vendorRegister()">Register</button>
<p id="regMsg" style="color:red;"></p>
<button class="cancel action-btn" onclick="showLogin()">Back to Login</button>
</div>

<div id="dashboardPage" class="page">
<h2>Welcome, <span id="vendorName"></span></h2>
<button onclick="logout()">Logout</button>
<a href="index.html" target="_blank" style="margin-left: 15px; color: #28a745; font-weight: bold;">View Shop</a>

<div id="addProductContainer">
    <h3 id="formTitle">Add Product</h3>
    <input type="hidden" id="editProductId">
    <input type="text" id="prodName" placeholder="Product Name">
    <input type="text" id="prodCategory" placeholder="Category">
    <input type="number" id="prodPrice" placeholder="Price">
    <input type="number" id="prodStock" placeholder="Stock Quantity">
    <input type="url" id="prodImageURL" placeholder="Product Image URL">
    
    <div id="actionButtons">
        <button class="add action-btn" id="addProductBtn" onclick="addProduct()">Add Product</button>
        <button class="update action-btn" id="updateProductBtn" style="display:none;" onclick="updateProduct()">Update Product</button>
        <button class="cancel action-btn" id="cancelEditBtn" style="display:none;" onclick="resetForm()">Cancel</button>
    </div>
</div>

<h3>My Products</h3>
<table id="productTable">
<thead>
<tr>
<th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Image</th><th>Status</th><th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<script>
// ===== GLOBAL STATE =====
let vendors = JSON.parse(localStorage.getItem("vendors")||'[]');
let products = JSON.parse(localStorage.getItem("products")||'[]');
let editingIndex = null;
let currentVendor = JSON.parse(localStorage.getItem('currentVendor')||'null');

// ===== INIT =====
if(currentVendor){ showPage('dashboard'); } else { showPage('login'); }

function showPage(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  if(page==='dashboard'){
    document.getElementById('vendorName').innerText=currentVendor.name;
    renderProducts();
  }
  document.getElementById(page+'Page').style.display='block';
}

function showRegister(){ showPage('register'); }
function showLogin(){ showPage('login'); }

// ====== AUTH =====
function vendorRegister(){
  let name=document.getElementById('regName').value.trim();
  let whatsapp=document.getElementById('regWhatsapp').value.trim();
  let pass=document.getElementById('regPass').value.trim();
  if(!name || !whatsapp || !pass){ document.getElementById('regMsg').innerText='Fill all fields'; return; }
  let id = 'vendor'+(vendors.length+1);
  vendors.push({id,name,whatsapp,password:pass,status:'Pending',promocode:'PROMO'+(vendors.length+1)});
  localStorage.setItem('vendors',JSON.stringify(vendors));
  document.getElementById('regMsg').innerText='Registered! Wait for admin approval.';
}

function vendorLogin(){
  let id=document.getElementById('vendorId').value.trim();
  let pass=document.getElementById('vendorPass').value.trim();
  let v = vendors.find(v=>v.id===id && v.password===pass);
  if(!v){ document.getElementById('msg').innerText='Invalid ID or password'; return; }
  if(v.status!=='Approved'){ document.getElementById('msg').innerText='Not approved by admin yet'; return; }
  currentVendor=v;
  localStorage.setItem('currentVendor',JSON.stringify(v));
  showPage('dashboard');
}

function logout(){ localStorage.removeItem('currentVendor'); currentVendor=null; showPage('login'); }

// ====== PRODUCTS =====
function generateProductId(){
  return products.length>0 ? Math.max(...products.map(p=>p.id))+1 : 1;
}

function resetForm(){
  document.getElementById('prodName').value='';
  document.getElementById('prodCategory').value='';
  document.getElementById('prodPrice').value='';
  document.getElementById('prodStock').value='';
  document.getElementById('prodImageURL').value='';
  editingIndex=null;
  document.getElementById('formTitle').innerText='Add Product';
  document.getElementById('addProductBtn').style.display='block';
  document.getElementById('updateProductBtn').style.display='none';
  document.getElementById('cancelEditBtn').style.display='none';
}

function renderProducts(){
  const tbody=document.querySelector('#productTable tbody');
  tbody.innerHTML='';
  const vendorProducts = products.filter(p=>p.vendorId===currentVendor.id);
  if(vendorProducts.length===0){ tbody.innerHTML='<tr><td colspan="7">No products added</td></tr>'; return; }
  vendorProducts.forEach((p)=>{
    const idx=products.findIndex(pr=>pr.id===p.id);
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td>
                  <td>${p.category}</td>
                  <td>$${p.price.toFixed(2)}</td>
                  <td>${p.stock}</td>
                  <td><img class='product-img' src='${p.imageURL}'></td>
                  <td>${p.status}</td>
                  <td>
                    <button class="update" onclick="editProduct(${idx})">Edit</button>
                    <button class="delete" onclick="deleteProduct(${idx})">Delete</button>
                  </td>`;
    tbody.appendChild(tr);
  });
}

function addProduct(){
  let name=document.getElementById('prodName').value.trim();
  let category=document.getElementById('prodCategory').value.trim();
  let price=parseFloat(document.getElementById('prodPrice').value);
  let stock=parseInt(document.getElementById('prodStock').value);
  let imageURL=document.getElementById('prodImageURL').value.trim();
  if(!name || !category || isNaN(price) || isNaN(stock) || !imageURL){ alert("Fill all fields correctly"); return; }
  products.push({id:generateProductId(),name,category,price,stock,imageURL,vendorId:currentVendor.id,status:'Pending'});
  localStorage.setItem('products',JSON.stringify(products));
  renderProducts(); resetForm();
}

function editProduct(i){
  editingIndex=i;
  let p=products[i];
  document.getElementById('prodName').value=p.name;
  document.getElementById('prodCategory').value=p.category;
  document.getElementById('prodPrice').value=p.price;
  document.getElementById('prodStock').value=p.stock;
  document.getElementById('prodImageURL').value=p.imageURL;
  document.getElementById('formTitle').innerText=`Edit Product: ${p.name}`;
  document.getElementById('addProductBtn').style.display='none';
  document.getElementById('updateProductBtn').style.display='block';
  document.getElementById('cancelEditBtn').style.display='inline-block';
}

function updateProduct(){
  if(editingIndex===null){ alert("No product selected"); return; }
  let name=document.getElementById('prodName').value.trim();
  let category=document.getElementById('prodCategory').value.trim();
  let price=parseFloat(document.getElementById('prodPrice').value);
  let stock=parseInt(document.getElementById('prodStock').value);
  let imageURL=document.getElementById('prodImageURL').value.trim();
  if(!name || !category || isNaN(price) || isNaN(stock) || !imageURL){ alert("Fill all fields"); return; }
  let p=products[editingIndex];
  if(p.vendorId!==currentVendor.id){ alert("Not your product"); return; }
  p.name=name; p.category=category; p.price=price; p.stock=stock; p.imageURL=imageURL; p.status='Pending';
  localStorage.setItem('products',JSON.stringify(products));
  renderProducts(); resetForm();
}

function deleteProduct(i){
  if(products[i].vendorId!==currentVendor.id){ alert("Not your product"); return; }
  if(confirm(`Delete ${products[i].name}?`)){ products.splice(i,1); localStorage.setItem('products',JSON.stringify(products)); renderProducts(); resetForm(); }
}

</script>
</body>
</html>
