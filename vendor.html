<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Dashboard</title>
    <style>
        /* Base Styles */
        body { font-family: Arial, sans-serif; background: #f4f4f9; color: #333; margin: 0; padding: 0; }
        header { background: #343a40; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.5em; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* Dashboard */
        #dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); text-align: center; }
        .stat-card h3 { color: #007bff; margin-top: 0; }
        .stat-card p { font-size: 2em; font-weight: bold; margin: 5px 0 0; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #e9ecef; font-weight: bold; color: #495057; }
        tr:hover { background-color: #f1f1f1; }
        .action-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: background 0.3s; margin-right: 5px; }
        .action-btn:hover { background: #0056b3; }
        
        /* Product Image Thumbnail Style */
        .thumb-img { 
            width: 50px; 
            height: 50px; 
            object-fit: cover; 
            border-radius: 4px; 
            border: 1px solid #ccc;
        }

        /* Forms/Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .modal-footer button { margin-left: 10px; }
        
        /* Auth Page */
        #auth-page { max-width: 400px; margin: 50px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center; }
        #auth-page h2 { color: #343a40; margin-bottom: 20px; }
        .auth-toggle button { width: 48%; padding: 10px; margin-bottom: 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .auth-toggle button.active { background: #007bff; }
    </style>
</head>
<body>

<header>
    <h1>Vendor Dashboard</h1>
    <span id="welcomeMsg" style="color: #ffc107;"></span>
    <button id="logoutBtn" style="background: #dc3545; display:none;" onclick="logout()">Logout</button>
</header>

<div id="auth-page">
    <h2>Vendor Access</h2>
    <div class="auth-toggle">
        <button id="loginToggle" class="active" onclick="toggleAuth('login')">Login</button>
        <button id="registerToggle" onclick="toggleAuth('register')">Register</button>
    </div>

    <div id="login-div">
        <input type="text" id="vendorUsernameLogin" placeholder="Username">
        <input type="password" id="vendorPasswordLogin" placeholder="Password">
        <button class="action-btn" onclick="vendorLogin()">Login</button>
        <p id="loginMsg" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="register-div" style="display: none;">
        <input type="text" id="vendorUsernameRegister" placeholder="Username">
        <input type="text" id="vendorEmailRegister" placeholder="Email">
        <input type="password" id="vendorPasswordRegister" placeholder="Password">
        <input type="text" id="vendorBankDetailsRegister" placeholder="Bank/Payment Details">
        <button class="action-btn" onclick="vendorRegister()">Register</button>
        <p id="registerMsg" style="color: red; margin-top: 10px;"></p>
    </div>
</div>

<div class="container" id="vendor-content" style="display:none;">

    <h2>Dashboard Summary</h2>
    <div id="dashboard">
        <div class="stat-card"><h3>Total Products</h3><p id="totalProducts">0</p></div>
        <div class="stat-card"><h3>Pending Approval</h3><p id="pendingProducts">0</p></div>
        <div class="stat-card"><h3>Total Stock Value</h3><p id="totalStockValue">$0.00</p></div>
        <div class="stat-card"><h3>Recent Orders</h3><p id="recentOrders">0</p></div>
    </div>

    <h2 style="margin-top: 30px;">Product Management</h2>
    <button class="action-btn" onclick="openAddModal()">+ Add New Product</button>
    
    <table id="productTable">
        <thead>
            <tr>
                <th>Image</th>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="productList">
            </tbody>
    </table>
    
    <h2 style="margin-top: 30px;">Recent Orders</h2>
    <table id="orderTable">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Items</th>
                <th>Status</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="orderList">
            </tbody>
    </table>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <h3>Add New Product</h3>
        <input type="text" id="productName" placeholder="Product Name">
        <select id="productCategory">
            <option value="">Select Category</option>
            <option value="Groceries">Groceries</option>
            <option value="Fashion">Fashion</option>
            <option value="Electronics">Electronics</option>
            <option value="Household">Household</option>
        </select>
        <input type="number" id="productPrice" placeholder="Price ($)">
        <input type="number" id="productStock" placeholder="Stock Quantity">
        <input type="text" id="productImageURL" placeholder="Image URL (e.g., ./images/item.jpg or full URL)">
        
        <div class="modal-footer">
            <button onclick="closeModal('addModal')">Cancel</button>
            <button class="action-btn" onclick="addProduct()">Save Product</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Edit Product</h3>
        <input type="hidden" id="editId">
        <input type="text" id="editName" placeholder="Product Name">
        <select id="editCategory">
            <option value="Groceries">Groceries</option>
            <option value="Fashion">Fashion</option>
            <option value="Electronics">Electronics</option>
            <option value="Household">Household</option>
        </select>
        <input type="number" id="editPrice" placeholder="Price ($)">
        <input type="number" id="editStock" placeholder="Stock Quantity">
        <input type="text" id="editImageURL" placeholder="Image URL (e.g., ./images/item.jpg or full URL)">
        
        <div class="modal-footer">
            <button onclick="closeModal('editModal')">Cancel</button>
            <button class="action-btn" onclick="saveEdit()">Save Changes</button>
        </div>
    </div>
</div>

<script>
// ==== INITIALIZE LOCALSTORAGE DATA MODELS (UNCHANGED) ====
function initializeLocalStorage() {
    // Default products (Add imageURL to default products if not exists)
    let products = JSON.parse(localStorage.getItem('products') || '[]');
    if (products.length === 0) {
        products = [
            { id: 1, name: 'Premium Rice (5kg)', category: 'Groceries', price: 6.50, stock: 100, vendorId: 101, status: 'Approved', promoCodeAssigned: 'RICE10', imageURL: 'https://via.placeholder.com/50/28a745/ffffff?text=Rice' },
            { id: 2, name: 'Organic Eggs (1 doz)', category: 'Groceries', price: 2.80, stock: 50, vendorId: 101, status: 'Approved', promoCodeAssigned: '', imageURL: 'https://via.placeholder.com/50/ffc107/000000?text=Eggs' },
            { id: 3, name: 'T-Shirt (Blue)', category: 'Fashion', price: 12.00, stock: 80, vendorId: 102, status: 'Approved', promoCodeAssigned: 'FASHION20', imageURL: 'https://via.placeholder.com/50/007bff/ffffff?text=Shirt' },
            { id: 4, name: 'Smartphone A99', category: 'Electronics', price: 350.00, stock: 10, vendorId: 103, status: 'Pending', promoCodeAssigned: '', imageURL: 'https://via.placeholder.com/50/6c757d/ffffff?text=Phone' },
        ];
        localStorage.setItem('products', JSON.stringify(products));
    } else {
         // Ensure existing products have an imageURL property for consistency
         products = products.map(p => ({ ...p, imageURL: p.imageURL || '' }));
         localStorage.setItem('products', JSON.stringify(products));
    }

    if (!localStorage.getItem('vendors')) {
        localStorage.setItem('vendors', JSON.stringify([
            { id: 101, username: 'grocer_a', email: 'grocer@example.com', password: '123', status: 'Approved', bankDetails: 'Bank A/C 123' },
            { id: 102, username: 'fashion_b', email: 'fashion@example.com', password: '123', status: 'Approved', bankDetails: 'Bank A/C 456' },
            { id: 103, username: 'electro_c', email: 'electro@example.com', password: '123', status: 'Pending', bankDetails: 'Bank A/C 789' },
        ]));
    }
    if (!localStorage.getItem('orders')) {
        localStorage.setItem('orders', JSON.stringify([
            { id: 1, customer: 'test', items: [{ id: 1, name: 'Premium Rice (5kg)', price: 6.50, quantity: 2, vendorId: 101 }], total: 13.00, status: 'Delivered', date: new Date().toISOString() },
            { id: 2, customer: 'test', items: [{ id: 3, name: 'T-Shirt (Blue)', price: 12.00, quantity: 1, vendorId: 102 }], total: 12.00, status: 'Pending', date: new Date().toISOString() }
        ]));
    }
}
initializeLocalStorage();


// ==== GLOBAL STATE & DATA FETCH ====
let vendors = JSON.parse(localStorage.getItem('vendors') || '[]');
let products = JSON.parse(localStorage.getItem('products') || '[]');
let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let loggedVendor = JSON.parse(localStorage.getItem('loggedVendor') || 'null');


// ==== AUTH CONTROL ====
function toggleAuth(mode) {
    document.getElementById('login-div').style.display = mode === 'login' ? 'block' : 'none';
    document.getElementById('register-div').style.display = mode === 'register' ? 'block' : 'none';
    document.getElementById('loginToggle').classList.toggle('active', mode === 'login');
    document.getElementById('registerToggle').classList.toggle('active', mode === 'register');
}

function vendorRegister() {
    const username = document.getElementById('vendorUsernameRegister').value.trim();
    const email = document.getElementById('vendorEmailRegister').value.trim();
    const password = document.getElementById('vendorPasswordRegister').value;
    const bankDetails = document.getElementById('vendorBankDetailsRegister').value.trim();

    if (!username || !email || !password || !bankDetails) {
        document.getElementById('registerMsg').innerText = "Please fill all fields.";
        return;
    }
    if (vendors.some(v => v.username === username)) {
        document.getElementById('registerMsg').innerText = "Username already exists.";
        return;
    }

    const newVendor = {
        id: vendors.length > 0 ? vendors[vendors.length - 1].id + 1 : 101,
        username,
        email,
        password,
        status: 'Pending', // New vendors need admin approval
        bankDetails
    };
    vendors.push(newVendor);
    localStorage.setItem('vendors', JSON.stringify(vendors));
    alert('Registration successful! Waiting for Admin approval.');
    toggleAuth('login');
    document.getElementById('registerMsg').innerText = "Registered successfully. Please login after Admin approval.";
}

function vendorLogin() {
    const username = document.getElementById('vendorUsernameLogin').value.trim();
    const password = document.getElementById('vendorPasswordLogin').value;

    const vendor = vendors.find(v => v.username === username && v.password === password);

    if (!vendor) {
        document.getElementById('loginMsg').innerText = "Invalid username or password.";
        return;
    }
    if (vendor.status !== 'Approved') {
        document.getElementById('loginMsg').innerText = `Your account status is: ${vendor.status}. Please contact Admin.`;
        return;
    }

    loggedVendor = vendor;
    localStorage.setItem('loggedVendor', JSON.stringify(loggedVendor));
    document.getElementById('auth-page').style.display = 'none';
    document.getElementById('vendor-content').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'inline-block';
    document.getElementById('welcomeMsg').innerText = `Welcome, ${loggedVendor.username}!`;
    loadDashboard();
}

function logout() {
    loggedVendor = null;
    localStorage.removeItem('loggedVendor');
    document.getElementById('vendor-content').style.display = 'none';
    document.getElementById('auth-page').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('welcomeMsg').innerText = '';
    document.getElementById('loginMsg').innerText = '';
    toggleAuth('login');
}

// ==== INITIAL LOAD CHECK ====
document.addEventListener('DOMContentLoaded', () => {
    if (loggedVendor) {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('vendor-content').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('welcomeMsg').innerText = `Welcome, ${loggedVendor.username}!`;
        loadDashboard();
    } else {
        document.getElementById('auth-page').style.display = 'block';
        document.getElementById('vendor-content').style.display = 'none';
        toggleAuth('login');
    }
});


// ==== DASHBOARD & DATA LOADING ====
function loadDashboard() {
    // Reload data from localStorage to get latest updates
    products = JSON.parse(localStorage.getItem('products') || '[]');
    orders = JSON.parse(localStorage.getItem('orders') || '[]');

    const vendorProducts = products.filter(p => p.vendorId === loggedVendor.id);
    const vendorOrders = orders.filter(o => o.items.some(item => item.vendorId === loggedVendor.id));

    // Stats
    const totalProducts = vendorProducts.length;
    const pendingProducts = vendorProducts.filter(p => p.status === 'Pending').length;
    const totalStockValue = vendorProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);
    const recentOrders = vendorOrders.length; // Simple count for recent orders

    document.getElementById('totalProducts').innerText = totalProducts;
    document.getElementById('pendingProducts').innerText = pendingProducts;
    document.getElementById('totalStockValue').innerText = `$${totalStockValue.toFixed(2)}`;
    document.getElementById('recentOrders').innerText = recentOrders;

    renderProducts(vendorProducts);
    renderOrders(vendorOrders.slice(-5).reverse()); // Show last 5 orders
}

// ==== PRODUCT MANAGEMENT ====
function renderProducts(vendorProducts) {
    const list = document.getElementById('productList');
    list.innerHTML = '';

    if (vendorProducts.length === 0) {
        list.innerHTML = '<tr><td colspan="8" style="text-align: center;">No products added yet.</td></tr>';
        return;
    }

    vendorProducts.forEach(p => {
        const row = document.createElement('tr');
        // ⭐ Image URL ব্যবহার করে থাম্বনেইল দেখানো হচ্ছে ⭐
        const imageUrl = p.imageURL || 'https://via.placeholder.com/50?text=No+Img';
        
        row.innerHTML = `
            <td><img src="${imageUrl}" class="thumb-img" alt="${p.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/50?text=Err';"></td>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>$${p.price.toFixed(2)}</td>
            <td>${p.stock}</td>
            <td style="color: ${p.status === 'Approved' ? 'green' : 'orange'}; font-weight: bold;">${p.status}</td>
            <td>
                <button class="action-btn" onclick="openEditModal(${p.id})">Edit</button>
                <button class="action-btn" style="background: #dc3545;" onclick="deleteProduct(${p.id})">Delete</button>
            </td>
        `;
        list.appendChild(row);
    });
}

function openAddModal() {
    document.getElementById('productName').value = '';
    document.getElementById('productCategory').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productStock').value = '';
    document.getElementById('productImageURL').value = ''; // ⭐ রিসেট imageURL
    document.getElementById('addModal').style.display = 'flex';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// ⭐ UPDATED: addProduct function with imageURL ⭐
function addProduct() {
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('productCategory').value;
    const price = parseFloat(document.getElementById('productPrice').value);
    const stock = parseInt(document.getElementById('productStock').value);
    const imageURL = document.getElementById('productImageURL').value.trim(); // ⭐ Fetched Image URL

    if (!name || !category || isNaN(price) || isNaN(stock) || stock < 0 || price < 0.01) {
        alert("Please fill all fields correctly.");
        return;
    }

    const newProduct = {
        id: products.length > 0 ? products[products.length - 1].id + 1 : 1,
        name: name,
        category: category,
        price: price,
        stock: stock,
        vendorId: loggedVendor.id,
        status: 'Pending', 
        promoCodeAssigned: '',
        imageURL: imageURL // ⭐ Save Image URL
    };

    products.push(newProduct);
    localStorage.setItem('products', JSON.stringify(products));
    closeModal('addModal');
    loadDashboard();
    alert('Product added. Waiting for Admin approval.');
}

// ⭐ UPDATED: openEditModal function with imageURL ⭐
function openEditModal(id) {
    const product = products.find(p => p.id === id);
    if (product) {
        // Ensure this product belongs to the logged in vendor
        if (product.vendorId !== loggedVendor.id) {
            alert("You do not have permission to edit this product.");
            return;
        }

        document.getElementById('editId').value = product.id;
        document.getElementById('editName').value = product.name;
        document.getElementById('editCategory').value = product.category;
        document.getElementById('editPrice').value = product.price;
        document.getElementById('editStock').value = product.stock;
        document.getElementById('editImageURL').value = product.imageURL || ''; // ⭐ Load existing Image URL
        
        document.getElementById('editModal').style.display = 'flex';
    }
}

// ⭐ UPDATED: saveEdit function with imageURL ⭐
function saveEdit() {
    const editId = parseInt(document.getElementById('editId').value);
    const name = document.getElementById('editName').value.trim();
    const category = document.getElementById('editCategory').value;
    const price = parseFloat(document.getElementById('editPrice').value);
    const stock = parseInt(document.getElementById('editStock').value);
    const imageURL = document.getElementById('editImageURL').value.trim(); // ⭐ Fetched Image URL

    if (!name || !category || isNaN(price) || isNaN(stock) || stock < 0 || price < 0.01) {
        alert("Please fill all fields correctly.");
        return;
    }

    const productIndex = products.findIndex(p => p.id === editId && p.vendorId === loggedVendor.id);

    if (productIndex !== -1) {
        products[productIndex].name = name;
        products[productIndex].category = category;
        products[productIndex].price = price;
        products[productIndex].stock = stock;
        products[productIndex].status = 'Pending'; // Re-approve after edit
        products[productIndex].imageURL = imageURL; // ⭐ Save Image URL
        
        localStorage.setItem('products', JSON.stringify(products));
        closeModal('editModal');
        loadDashboard();
        alert('Product updated. Waiting for Admin re-approval.');
    } else {
        alert("Error: Product not found or unauthorized edit.");
    }
}

function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;

    const initialLength = products.length;
    products = products.filter(p => p.id !== id || p.vendorId !== loggedVendor.id);

    if (products.length < initialLength) {
        localStorage.setItem('products', JSON.stringify(products));
        loadDashboard();
        alert('Product deleted successfully.');
    } else {
        alert("Error: Product not found or unauthorized deletion.");
    }
}

// ==== ORDER MANAGEMENT ====
function renderOrders(vendorOrders) {
    const list = document.getElementById('orderList');
    list.innerHTML = '';

    if (vendorOrders.length === 0) {
        list.innerHTML = '<tr><td colspan="6" style="text-align: center;">No orders yet.</td></tr>';
        return;
    }

    vendorOrders.forEach(o => {
        // Filter items to show only items belonging to the loggedVendor
        const relevantItems = o.items.filter(item => item.vendorId === loggedVendor.id);
        
        if (relevantItems.length > 0) {
            const itemsSummary = relevantItems.map(item => `${item.name} (x${item.quantity})`).join(', ');
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>#${o.id}</td>
                <td>${o.customer}</td>
                <td>$${o.total}</td>
                <td>${itemsSummary}</td>
                <td style="color: ${o.status === 'Delivered' ? 'green' : o.status === 'Pending' ? 'orange' : 'red'}; font-weight: bold;">${o.status}</td>
                <td>${new Date(o.date).toLocaleDateString()}</td>
            `;
            list.appendChild(row);
        }
    });
    // Check again if any vendor-specific orders were rendered
    if (list.innerHTML === '') {
        list.innerHTML = '<tr><td colspan="6" style="text-align: center;">No recent orders for your products.</td></tr>';
    }
}

</script>
</body>
</html>
