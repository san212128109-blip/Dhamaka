<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dhamaka Daily Items - Shop</title>
<style>
/* CSS à¦•à§‹à¦¡ à¦…à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¿à¦¤ à¦°à¦¾à¦–à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡ */
body{font-family:Arial,sans-serif;background:#d4edda;color:#155724;transition:0.3s;}
body.dark{background:#121212;color:#ddd;}
header{background:#28a745;color:white;padding:1em;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;}
header h1{margin:0;font-size:1.5em;}

/* NAV à¦¸à§à¦Ÿà¦¾à¦‡à¦² à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦²à§‹: à¦®à§‡à¦¨à§ à¦…à§à¦¯à¦¾à¦²à¦¾à¦‡à¦¨à¦®à§‡à¦¨à§à¦Ÿ à¦ à¦¿à¦• à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡ */
nav{
Â  Â  display:flex;
Â  Â  align-items:center;
Â  Â  flex-wrap:wrap;
Â  Â  gap: 1em; /* à¦®à§‡à¦¨à§ à¦†à¦‡à¦Ÿà§‡à¦®à¦—à§à¦²à§‹à¦° à¦®à¦§à§à¦¯à§‡ à¦¬à§à¦¯à¦¬à¦§à¦¾à¦¨ */
}
nav a{
Â  Â  color:white;
Â  Â  text-decoration:none;
Â  Â  font-weight:bold;
Â  Â  transition:0.3s;
Â  Â  position:relative;
}
nav a:hover{text-decoration:underline;color:#ffc107;}
nav #cartLink::after{content:attr(data-count);position:absolute;top:-10px;right:-10px;background:red;color:white;width:20px;height:20px;text-align:center;line-height:20px;border-radius:50%;font-size:0.8em;display:inline-block;}
nav button{margin-left:1em;cursor:pointer;}
.page{display:none;padding:1em;}
h1,h2,h3{text-align:center;margin-bottom:0.5em;}
.product-list,.cart-list{display:flex;flex-wrap:wrap;gap:1em;justify-content:center;margin-top:1em;}
.product{border:1px solid #28a745;border-radius:12px;padding:1em;width:200px;text-align:center;background:#fff;box-shadow:2px2px10px rgba(0,0,0,0.1);transition:0.3s;position:relative;overflow:hidden;}
.product:hover{transform:scale(1.05);box-shadow:4px4px15px rgba(0,0,0,0.2);}
.product img{transition: transform 0.3s;}
.product:hover img{transform:scale(1.2);}
.badge{position:absolute;top:10px;left:10px;background:#ffc107;color:#000;padding:2px 6px;border-radius:4px;font-size:0.8em;animation:bounce 1s infinite alternate;}
@keyframes bounce{0%{transform:translateY(0);}100%{transform:translateY(-5px);}}
button{background:#28a745;color:white;border:none;padding:0.5em 1em;border-radius:5px;cursor:pointer;margin-top:0.5em;transition:0.3s;}
button:hover{background:#218838;}
input,select,textarea{padding:0.5em;margin:0.3em 0;width:90%;border-radius:5px;border:1px solid #ccc;}
#cartSummary{text-align:center;margin-top:1em;font-weight:bold;}
/* Updated Carousel Styles for better Admin integration */
.carousel{display:flex;overflow:hidden;width:90%;margin:1em auto;position:relative;border-radius:12px; border: 3px solid #ffc107; height: 300px; overflow-x: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.2);}
.carousel-track {display: flex; transition: transform 0.5s ease-in-out; height: 100%;}
.carousel-slide {min-width: 100%; height: 100%;}
.carousel-slide img{width: 100%; height: 100%; object-fit: cover; border-radius: 9px;}
.star{color:gold;font-size:1em;cursor:pointer;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;animation:fadeIn 0.3s;}
.modal-content{background:#fff;padding:1em;border-radius:12px;width:90%;max-width:400px;text-align:center;}
.modal button{width:45%;margin:0.5em;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
#support{position:fixed;bottom:20px;right:20px;background:#25D366;color:white;padding:10px 15px;border-radius:50px;cursor:pointer;box-shadow:2px2px10px rgba(0,0,0,0.2);}
.product-image-container img {width: 150px; height: 150px; object-fit: cover; border-radius: 8px;}
@media(max-width:600px){Â 
Â  Â  .product{width:45%; }Â 
Â  Â  header{flex-direction:column;align-items:flex-start;}Â 
Â  Â  /* NAV à¦¸à§à¦Ÿà¦¾à¦‡à¦² à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦­à¦¿à¦‰à¦¯à¦¼à§‡à¦° à¦œà¦¨à§à¦¯ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦²à§‹ */
Â  Â  nav {flex-direction: row; gap: 0.5em; margin-top: 5px; width: 100%; justify-content: space-between;}Â 
Â  Â  nav a{margin:0;}
Â  Â  nav button{margin-left: 0; margin-right: 0;}
Â  Â  .carousel {height: 150px;} /* à¦›à§‹à¦Ÿ à¦¸à§à¦•à§à¦°à¦¿à¦¨à§‡à¦° à¦œà¦¨à§à¦¯ à¦•à§à¦¯à¦¾à¦°à¦¾à¦‰à¦œà§‡à¦²à§‡à¦° à¦‰à¦šà§à¦šà¦¤à¦¾ à¦•à¦®à¦¾à¦¨à§‹ à¦¹à¦²à§‹ */
}
#home {padding-top: 20px;}
.product-list {padding: 20px 0; border-top: 1px solid #28a745;}
#reviewSectionContainer {max-width: 900px; margin: 30px auto; padding: 20px; background: #f8f9fa; border-radius: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);}
.review-item {border-bottom: 1px dashed #ccc; padding: 10px 0; text-align: left;}
.review-item:last-child {border-bottom: none;}
.review-customer {font-size: 0.9em; color: #6c757d;}
.review-customer b {color: #000;}
#loginToggleBtn, #registerToggleBtn {width: 45%; background-color: #6c757d;}
.promo-info {color: #dc3545; font-weight: bold; margin-top: 10px;}
</style>
</head>
<body>

<header>
<h1>Dhamaka Daily Items</h1>
<nav>
<a href="#home" onclick="showPage('home')">Home</a>
<a href="#categories" onclick="showPage('categories')">Products</a>
<a id="cartLink" href="#cart" data-count="0" onclick="showPage('cart')">Cart</a>
<button onclick="toggleDarkMode()">ğŸŒ™</button>
<button id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>
</nav>
</header>

<div id="home" class="page">
<h2>â­ Hot Promotions</h2>
<div class="carousel" id="carousel">
Â  Â  <div class="carousel-track">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
</div>
<h2 style="margin-top: 20px;">Featured Products</h2>
<div class="product-list" id="homeList"></div>
<div style="text-align:center;margin:20px 0;">
<button onclick="showPage('categories')">View All Products â†’</button>
</div>
<div id="reviewSectionContainer">
Â  Â  <h3>â­ Customer Reviews </h3>
Â  Â  <div id="reviewList"></div>
Â  Â  <hr style="margin:15px 0;">
Â  Â  <div id="reviewForm">
Â  Â  Â  Â  <h3>Submit Your Review</h3>
Â  Â  Â  Â  <p id="reviewAuthMsg" style="color: red; display: none;">Please login to submit a review.</p>
Â  Â  Â  Â  <div id="ratingStars"></div>
Â  Â  Â  Â  <textarea id="reviewText" placeholder="Your review"></textarea>
Â  Â  Â  Â  <button onclick="submitReview()">Submit Review</button>
Â  Â  </div>
</div>
</div>

<div id="categories" class="page">
<h2>All Products</h2>
<select id="categoryFilter" onchange="filterCategory()"><option value="All">All</option></select>
<input type="text" id="searchInput" placeholder="Search Products..." oninput="filterCategory()">
<select id="sortSelect" onchange="filterCategory()">
<option value="">Sort By</option>
<option value="price-asc">Price Lowâ†’High</option>
<option value="price-desc">Price Highâ†’Low</option>
<option value="name-asc">Name Aâ†’Z</option>
<option value="name-desc">Name Zâ†’A</option>
</select>
<div class="product-list" id="categoryList"></div>
</div>

<div id="cart" class="page">
<h2>Your Cart</h2>
<div class="cart-list" id="cartList"></div>
<div id="cartSummary"></div>
<input type="text" id="promoCodeInput" placeholder="Enter Promocode">
<button onclick="applyPromo()">Apply Promocode</button>
<div id="promoResult" class="promo-info"></div>
<button onclick="checkout()">Checkout</button>
</div>

<div id="loginForm" class="page">
<h2>Customer Area</h2>
<div style="text-align:center;margin-bottom:1em;">
<button onclick="toggleAuthForm('login')" id="loginToggleBtn">Login</button>
<button onclick="toggleAuthForm('register')" id="registerToggleBtn">Register</button>
</div>

<div id="loginDiv" style="max-width:400px;margin:1em auto;text-align:center;">
<h3>Login</h3>
<input type="text" id="usernameLogin" placeholder="Username">
<input type="password" id="passwordLogin" placeholder="Password">
<button onclick="customerLogin()">Login</button>
<p id="loginMsg" style="color:red;"></p>
</div>

<div id="registerDiv" style="max-width:400px;margin:1em auto;text-align:center;display:none;">
<h3>Register</h3>
<input type="text" id="usernameRegister" placeholder="Username">
<input type="text" id="userWhatsappRegister" placeholder="WhatsApp Number">
<input type="text" id="userAddressRegister" placeholder="Address">
<input type="password" id="passwordRegister" placeholder="Password">
<button onclick="customerRegister()">Register</button>
<p id="registerMsg" style="color:red;"></p>
</div>
</div>

<div id="support" onclick="openWhatsApp()">ğŸ’¬ Support</div>

<script>
// ==== INITIALIZE LOCALSTORAGE DATA MODELS (à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡) ====
function initializeLocalStorage() {
Â  Â  // Default Products (à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡: imageURL à¦¯à§‹à¦— à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡)
Â  Â  if (!localStorage.getItem('products')) {
Â  Â  Â  Â  localStorage.setItem('products', JSON.stringify([
Â  Â  Â  Â  Â  Â  // à¦†à¦ªà¦¨à¦¾à¦° à¦†à¦¸à¦² à¦‡à¦®à§‡à¦œ URL à¦¦à¦¿à¦¯à¦¼à§‡ à¦à¦‡ 'https://via.placeholder.com/...' à¦¬à¦¦à¦²à§‡ à¦¦à¦¿à¦¨
Â  Â  Â  Â  Â  Â  { id: 1, name: 'Premium Rice (5kg)', category: 'Groceries', price: 6.50, stock: 100, vendorId: 101, status: 'Approved', promoCodeAssigned: 'RICE10', imageURL: 'https://via.placeholder.com/150/28a745/ffffff?text=Rice+5kg' },
Â  Â  Â  Â  Â  Â  { id: 2, name: 'Organic Eggs (1 doz)', category: 'Groceries', price: 2.80, stock: 50, vendorId: 101, status: 'Approved', promoCodeAssigned: '', imageURL: 'https://via.placeholder.com/150/ffc107/000000?text=Eggs+Doz' },
Â  Â  Â  Â  Â  Â  { id: 3, name: 'T-Shirt (Blue)', category: 'Fashion', price: 12.00, stock: 80, vendorId: 102, status: 'Approved', promoCodeAssigned: 'FASHION20', imageURL: 'https://via.placeholder.com/150/007bff/ffffff?text=Blue+T-Shirt' },
Â  Â  Â  Â  Â  Â  { id: 4, name: 'Smartphone A99', category: 'Electronics', price: 350.00, stock: 10, vendorId: 103, status: 'Approved', promoCodeAssigned: '', imageURL: 'https://via.placeholder.com/150/6c757d/ffffff?text=Smartphone' },
Â  Â  Â  Â  Â  Â  { id: 5, name: 'Running Shoes', category: 'Fashion', price: 45.00, stock: 30, vendorId: 102, status: 'Approved', promoCodeAssigned: '', imageURL: 'https://via.placeholder.com/150/17a2b8/ffffff?text=Shoes' },
Â  Â  Â  Â  Â  Â  { id: 6, name: 'Dish Soap (1L)', category: 'Household', price: 4.50, stock: 200, vendorId: 101, status: 'Approved', promoCodeAssigned: '', imageURL: 'https://via.placeholder.com/150/dc3545/ffffff?text=Dish+Soap' },
Â  Â  Â  Â  ]));
Â  Â  }
Â  Â  // Default Banners (à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡: imageURL à¦¯à§‹à¦— à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡)
Â  Â  if (!localStorage.getItem('banners')) {
Â  Â  Â  Â  localStorage.setItem('banners', JSON.stringify([
Â  Â  Â  Â  Â  Â  // à¦†à¦ªà¦¨à¦¾à¦° à¦†à¦¸à¦² à¦‡à¦®à§‡à¦œ URL à¦¦à¦¿à¦¯à¦¼à§‡ à¦à¦‡ 'https://via.placeholder.com/...' à¦¬à¦¦à¦²à§‡ à¦¦à¦¿à¦¨
Â  Â  Â  Â  Â  Â  { id: 1, imageURL: 'https://via.placeholder.com/1200x300/28a745/ffffff?text=12.12+Grand+Sale', link: '#categories' },Â 
Â  Â  Â  Â  Â  Â  { id: 2, imageURL: 'https://via.placeholder.com/1200x300/ffc107/000000?text=Upto+50%25+OFF', link: '#categories' },Â 
Â  Â  Â  Â  Â  Â  { id: 3, imageURL: 'https://via.placeholder.com/1200x300/6c757d/ffffff?text=New+Customer+Voucher', link: '#loginForm' }
Â  Â  Â  Â  ]));
Â  Â  }
Â  Â  // Default Reviews
Â  Â  if (!localStorage.getItem('reviews')) {
Â  Â  Â  Â  localStorage.setItem('reviews', JSON.stringify([
Â  Â  Â  Â  Â  Â  { id: 1, customerName: 'Guest User', rating: 5, text: 'Great products and fast delivery!', date: new Date().toLocaleDateString() }
Â  Â  Â  Â  ]));
Â  Â  }
Â  Â  // Default Customers
Â  Â  if (!localStorage.getItem('customers')) {
Â  Â  Â  Â  localStorage.setItem('customers', JSON.stringify([{username: 'test', whatsapp: '01XXXXXXXXX', address: 'Test address', password: '123'}]));
Â  Â  }
Â  Â  // Default Promo Code Usage (for Admin Panel)
Â  Â  if (!localStorage.getItem('promocodeUsage')) {
Â  Â  Â  Â  localStorage.setItem('promocodeUsage', JSON.stringify({}));
Â  Â  }
Â  Â  // Dummy Orders data (if not exists)
Â  Â  if (!localStorage.getItem('orders')) {
Â  Â  Â  Â  localStorage.setItem('orders', JSON.stringify([]));
Â  Â  }
}
initializeLocalStorage();


// ==== GLOBAL STATE & DATA FETCH ====
let products = [];Â 
let masterPromocodes = JSON.parse(localStorage.getItem("masterPromocodes")||'[]');
let banners = JSON.parse(localStorage.getItem("banners")||'[]');
let reviews = JSON.parse(localStorage.getItem("reviews")||'[]');
let cart = JSON.parse(localStorage.getItem("cart")||"[]");
let customers = JSON.parse(localStorage.getItem("customers")||'[]');
let loggedCustomer = JSON.parse(localStorage.getItem("loggedCustomer")||'null');
let appliedPromo = null; // Stores the currently applied promo object

// ==== PAGE CONTROL ====
function showPage(page){
Â  Â  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
Â  Â  document.getElementById(page).style.display='block';
Â  Â  renderAll();
Â  Â  if (page === 'home') {
Â  Â  Â  Â  startCarousel();
Â  Â  } else {
Â  Â  Â  Â  clearInterval(carouselInterval);
Â  Â  }
}

// Initial page load
document.addEventListener('DOMContentLoaded', () => {
Â  Â  // à¦²à¦—à¦‡à¦¨ à¦•à¦°à¦¾ à¦¨à¦¾ à¦¥à¦¾à¦•à¦²à§‡ loginForm à¦¦à§‡à¦–à¦¾à¦“, à¦¨à¦¾ à¦¹à¦²à§‡ home
Â  Â  if(loggedCustomer){Â 
Â  Â  Â  Â  showPage('home');Â 
Â  Â  Â  Â  document.getElementById('logoutBtn').style.display='inline-block';Â 
Â  Â  } else {Â 
Â  Â  Â  Â  showPage('loginForm');Â 
Â  Â  Â  Â  toggleAuthForm('login');
Â  Â  }
Â  Â  // Render features that don't depend on specific pages
Â  Â  renderReviews();
Â  Â  renderStarRatingForm();
});


function toggleDarkMode(){ document.body.classList.toggle('dark'); }

// ==== AUTH (UNCHANGED) ====
function toggleAuthForm(mode){
Â  Â  document.getElementById('loginDiv').style.display = mode==='login'?'block':'none';
Â  Â  document.getElementById('registerDiv').style.display = mode==='register'?'block':'none';
Â  Â  document.getElementById('loginToggleBtn').style.backgroundColor = mode==='login'?'#28a745':'#6c757d';
Â  Â  document.getElementById('registerToggleBtn').style.backgroundColor = mode==='register'?'#28a745':'#6c757d';
}

function customerRegister(){
Â  Â  let username=document.getElementById("usernameRegister").value.trim();
Â  Â  let whatsapp=document.getElementById("userWhatsappRegister").value.trim();
Â  Â  let address=document.getElementById("userAddressRegister").value.trim();
Â  Â  let password=document.getElementById("passwordRegister").value;
Â  Â  if(!username||!whatsapp||!address||!password){ document.getElementById("registerMsg").innerText="Fill all fields"; return; }
Â  Â  if(customers.some(c=>c.username===username)){ document.getElementById("registerMsg").innerText="Username exists"; return; }
Â  Â  customers.push({username,whatsapp,address,password});
Â  Â  localStorage.setItem("customers",JSON.stringify(customers));
Â  Â  toggleAuthForm('login');Â 
Â  Â  document.getElementById("registerMsg").innerText="Registered! Login now.";
}

function customerLogin(){
Â  Â  let username=document.getElementById("usernameLogin").value.trim();
Â  Â  let password=document.getElementById("passwordLogin").value;
Â  Â  let user = customers.find(c=>c.username===username && c.password===password);
Â  Â  if(!user){ document.getElementById("loginMsg").innerText="Invalid username/password"; return; }
Â  Â  loggedCustomer=user;Â 
Â  Â  localStorage.setItem("loggedCustomer",JSON.stringify(loggedCustomer));
Â  Â  showPage('home');Â 
Â  Â  document.getElementById('logoutBtn').style.display='inline-block';
}

function logout(){Â 
Â  Â  loggedCustomer=null;Â 
Â  Â  localStorage.removeItem("loggedCustomer");Â 
Â  Â  cart = [];
Â  Â  localStorage.removeItem("cart");
Â  Â  document.getElementById('promoResult').innerText = '';
Â  Â  appliedPromo = null;
Â  Â  showPage('loginForm');Â 
Â  Â  document.getElementById('logoutBtn').style.display='none';Â 
Â  Â  toggleAuthForm('login');Â 
}

// ==== RENDER PRODUCTS (à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡) ====
const homeList=document.getElementById("homeList");
const categoryList=document.getElementById("categoryList");
const cartList=document.getElementById("cartList");
const cartLink=document.getElementById("cartLink");

function renderAll() {
Â  Â  // â­ FIX: products array must be reloaded from localStorage in renderAll()
Â  Â  // à¦à¦Ÿà¦¿ à¦¨à¦¿à¦¶à§à¦šà¦¿à¦¤ à¦•à¦°à§‡ à¦¯à§‡ à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦…à¦¨à§à¦®à§‹à¦¦à¦¿à¦¤ à¦ªà¦£à§à¦¯à¦—à§à¦²à¦¿ à¦…à¦¬à¦¿à¦²à¦®à§à¦¬à§‡ à¦¦à§‹à¦•à¦¾à¦¨à§‡à¦° à¦œà¦¨à§à¦¯ à¦‰à¦ªà¦²à¦¬à§à¦§à¥¤
Â  Â  products = JSON.parse(localStorage.getItem("products")||'[]').filter(p=>p.status==='Approved');

Â  Â  // Other data reload
Â  Â  banners = JSON.parse(localStorage.getItem("banners")||'[]');Â 
Â  Â  masterPromocodes = JSON.parse(localStorage.getItem("masterPromocodes")||'[]');

Â  Â  renderProducts(homeList, products.slice(0, 6)); // Show first 6 approved products on home
Â  Â  // Ensure categoryList is rendered with all approved products
Â  Â  filterCategory();Â 
Â  Â  renderCart();
Â  Â  updateCartBadge();
Â  Â  populateCategoryFilter();
Â  Â  renderReviews();
}

function renderProducts(list, arr){
Â  Â  list.innerHTML=''; if(arr.length===0){ list.innerHTML="<p>No Approved products available.</p>"; return; }
Â  Â  arr.forEach(p=>{
Â  Â  Â  Â  // Note: The product index (idx) is now found relative to the global 'products' array,Â 
Â  Â  Â  Â  // which is reloaded in renderAll().
Â  Â  Â  Â  const idx=products.findIndex(pr=>pr.id===p.id);Â 
Â  Â  Â  Â  const div=document.createElement('div'); div.className='product';
Â  Â  Â  Â  const badgeHTML=p.promoCodeAssigned?`<div class="badge">${p.promoCodeAssigned}</div>`:'';
Â  Â  Â  Â  // â­ FIX: Placeholder image à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡ (à¦¯à§‡à¦¹à§‡à¦¤à§ à¦†à¦ªà¦¨à¦¾à¦° à¦†à¦¸à¦² à¦›à¦¬à¦¿ à¦¨à§‡à¦‡)
Â  Â  Â  Â  const imageUrl = p.imageURL || 'https://via.placeholder.com/150?text=No+Image';
Â  Â  Â  Â  div.innerHTML=`${badgeHTML}<div class="product-image-container"><img src="${imageUrl}" alt="${p.name}"></div>
Â  Â  Â  Â  <h3>${p.name}</h3><p>Category: ${p.category}</p><p><b>$${p.price.toFixed(2)}</b></p><p>Stock: ${p.stock}</p>
Â  Â  Â  Â  <button onclick="addToCart(${idx})" ${p.stock<=0?'disabled style="background-color:#ff6347;"':''}>${p.stock>0?'Add to Cart':'Out of Stock'}</button>`;
Â  Â  Â  Â  list.appendChild(div);
Â  Â  });
}

// ==== CAROUSEL (Admin Controlled) - UNCHANGED ====
let currentSlide = 0;
let carouselInterval;

function renderCarousel() {
Â  Â  const track = document.querySelector('#carousel .carousel-track');
Â  Â  track.innerHTML = '';
Â  Â  if (banners.length === 0) {
Â  Â  Â  Â  track.innerHTML = '<div class="carousel-slide" style="text-align:center; display:flex; justify-content:center; align-items:center;"><h3>No active banners.</h3></div>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  Â 
Â  Â  banners.forEach(banner => {
Â  Â  Â  Â  const slide = document.createElement('div');
Â  Â  Â  Â  slide.className = 'carousel-slide';
Â  Â  Â  Â  // à¦à¦–à¦¾à¦¨à§‡ alt à¦…à§à¦¯à¦¾à¦Ÿà§à¦°à¦¿à¦¬à¦¿à¦‰à¦Ÿ à¦¯à§‹à¦— à¦•à¦°à¦¾ à¦¹à¦²à§‹
Â  Â  Â  Â  slide.innerHTML = `<a href="${banner.link}"><img src="${banner.imageURL}" alt="Promotion Banner"></a>`;
Â  Â  Â  Â  track.appendChild(slide);
Â  Â  });
Â  Â  // Reset track position after rendering new slides
Â  Â  track.style.transform = `translateX(0%)`;
}

function moveCarousel() {
Â  Â  const track = document.querySelector('#carousel .carousel-track');
Â  Â  const totalSlides = banners.length;
Â  Â  if (totalSlides <= 1) return;

Â  Â  currentSlide = (currentSlide + 1) % totalSlides;
Â  Â  track.style.transform = `translateX(-${currentSlide * 100}%)`;
}

function startCarousel() {
Â  Â  renderCarousel();
Â  Â  if (banners.length > 1) {
Â  Â  Â  Â  clearInterval(carouselInterval);
Â  Â  Â  Â  currentSlide = 0;
Â  Â  Â  Â  carouselInterval = setInterval(moveCarousel, 5000); // Change slide every 5 seconds
Â  Â  } else {
Â  Â  Â  Â  clearInterval(carouselInterval); // Stop interval if 0 or 1 banner
Â  Â  }
}


// ==== CART (UNCHANGED) ====
function renderCart(){
Â  Â  cartList.innerHTML='';Â 
Â  Â  if(cart.length===0){Â 
Â  Â  Â  Â  cartList.innerHTML="<p>Your cart is empty.</p>";Â 
Â  Â  Â  Â  document.getElementById('promoCodeInput').style.display = 'none';
Â  Â  Â  Â  document.querySelector('#cart button[onclick="applyPromo()"]').style.display = 'none';
Â  Â  Â  Â  document.getElementById('promoResult').innerText = '';
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  Â 
Â  Â  document.getElementById('promoCodeInput').style.display = 'block';
Â  Â  document.querySelector('#cart button[onclick="applyPromo()"]').style.display = 'block';

Â  Â  cart.forEach((p,i)=>{
Â  Â  Â  Â  const div=document.createElement('div'); div.className='product';
Â  Â  Â  Â  const qty=p.quantity||1;
Â  Â  Â  Â  div.innerHTML=`<p><b>${p.name}</b></p>
Â  Â  Â  Â  <p>$${p.price.toFixed(2)} x ${qty} = $<b>${(p.price*qty).toFixed(2)}</b></p>
Â  Â  Â  Â  <input type="number" value="${qty}" min="1" max="${p.stock}" onchange="updateQuantity(${i},this.value)">
Â  Â  Â  Â  <button onclick="removeFromCart(${i})">Remove</button>`;
Â  Â  Â  Â  cartList.appendChild(div);
Â  Â  });
Â  Â  updateCartTotal();Â 
Â  Â  updateCartBadge();
}

function addToCart(i){
Â  Â  if(!loggedCustomer){Â 
Â  Â  Â  Â  alert("Please login first to add items to the cart!");Â 
Â  Â  Â  Â  showPage('loginForm');Â 
Â  Â  Â  Â  toggleAuthForm('login');Â 
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  // â­ FIX: Product is fetched from the global 'products' array which is now re-loaded in renderAll()
Â  Â  const product = products[i];Â 
Â  Â  if(!product || product.stock < 1){Â 
Â  Â  Â  Â  alert("Out of stock or product not found.");Â 
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  const exist=cart.find(item=>item.id===product.id);
Â  Â  if(exist){Â 
Â  Â  Â  Â  if((exist.quantity||1)>=product.stock){Â 
Â  Â  Â  Â  Â  Â  alert(`Maximum stock reached for ${product.name} (${product.stock} units).`);Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  exist.quantity=(exist.quantity||1)+1;Â 
Â  Â  } else{Â 
Â  Â  Â  Â  // Note: When adding to cart, save a copy of the product data
Â  Â  Â  Â  cart.push({...product, quantity:1});Â 
Â  Â  }
Â  Â  localStorage.setItem("cart",JSON.stringify(cart));Â 
Â  Â  renderCart();Â 
Â  Â  alert(`${product.name} added to cart!`);
}

function removeFromCart(i){Â 
Â  Â  cart.splice(i,1);Â 
Â  Â  localStorage.setItem("cart",JSON.stringify(cart));Â 
Â  Â  appliedPromo = null; // Remove promo if cart changes
Â  Â  document.getElementById('promoResult').innerText = '';
Â  Â  renderCart();Â 
}

function updateQuantity(i,val){Â 
Â  Â  const quantity=Number(val);Â 
Â  Â  if(quantity<1 || isNaN(quantity)) return;Â 
Â  Â  const p=cart[i];Â 
Â  Â  const stockP=products.find(pr=>pr.id===p.id);Â 
Â  Â  Â 
Â  Â  if(stockP && quantity>stockP.stock){Â 
Â  Â  Â  Â  alert(`Maximum available stock is ${stockP.stock}.`);Â 
Â  Â  Â  Â  cart[i].quantity=stockP.stock;Â 
Â  Â  } else{Â 
Â  Â  Â  Â  cart[i].quantity=quantity;Â 
Â  Â  }Â 
Â  Â  Â 
Â  Â  localStorage.setItem("cart",JSON.stringify(cart));Â 
Â  Â  appliedPromo = null; // Remove promo if cart changes
Â  Â  document.getElementById('promoResult').innerText = '';
Â  Â  updateCartTotal();Â 
}

function updateCartTotal(){Â 
Â  Â  let subtotal=cart.reduce((sum,p)=>sum+p.price*(p.quantity||1),0);
Â  Â  let finalTotal = subtotal;
Â  Â  let discount = 0;

Â  Â  if (appliedPromo) {
Â  Â  Â  Â  if (appliedPromo.minOrder > subtotal) {
Â  Â  Â  Â  Â  Â  Â document.getElementById('promoResult').innerText = `âŒ Subtotal ($${subtotal.toFixed(2)}) is less than minimum order for ${appliedPromo.code} ($${appliedPromo.minOrder.toFixed(2)})`;
Â  Â  Â  Â  Â  Â  Â appliedPromo = null;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â if (appliedPromo.type === 'percent') {
Â  Â  Â  Â  Â  Â  Â  Â  Â discount = subtotal * (appliedPromo.discount / 100);
Â  Â  Â  Â  Â  Â  Â } else if (appliedPromo.type === 'fixed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â discount = appliedPromo.discount;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â finalTotal = subtotal - discount;
Â  Â  Â  Â  Â  Â  Â document.getElementById('promoResult').innerText = `âœ… Promo ${appliedPromo.code} applied! Discount: $${discount.toFixed(2)}`;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  document.getElementById('cartSummary').innerHTML=`
Â  Â  Â  Â  Subtotal: $${subtotal.toFixed(2)}<br>
Â  Â  Â  Â  Discount: $${discount.toFixed(2)}<br>
Â  Â  Â  Â  <b>Final Total: $${finalTotal.toFixed(2)}</b>
Â  Â  `;
}

function updateCartBadge(){ cartLink.setAttribute('data-count',cart.length); }

// ==== CATEGORY/FILTER (UNCHANGED) ====
function filterCategory(){
Â  Â  let filtered=products;Â 
Â  Â  const cat=document.getElementById('categoryFilter').value;
Â  Â  const search=document.getElementById('searchInput').value.toLowerCase();
Â  Â  const sort=document.getElementById('sortSelect').value;
Â  Â  Â 
Â  Â  if(cat!=='All'){ filtered=filtered.filter(p=>p.category===cat); }
Â  Â  if(search){ filtered=filtered.filter(p=>p.name.toLowerCase().includes(search)); }
Â  Â  Â 
Â  Â  if(sort==='price-asc'){ filtered.sort((a,b)=>a.price-b.price); }
Â  Â  if(sort==='price-desc'){ filtered.sort((a,b)=>b.price-a.price); }
Â  Â  if(sort==='name-asc'){ filtered.sort((a,b)=>a.name.localeCompare(b.name)); }
Â  Â  if(sort==='name-desc'){ filtered.sort((a,b)=>b.name.localeCompare(a.name)); }
Â  Â  Â 
Â  Â  renderProducts(categoryList, filtered);
}

function populateCategoryFilter(){Â 
Â  Â  // Filter categories only from Approved products
Â  Â  const categories=[...new Set(products.map(p=>p.category))];Â 
Â  Â  const filter=document.getElementById('categoryFilter');Â 
Â  Â  filter.innerHTML='<option value="All">All</option>';Â 
Â  Â  categories.forEach(c=>{Â 
Â  Â  Â  Â  const opt=document.createElement('option');Â 
Â  Â  Â  Â  opt.value=c;Â 
Â  Â  Â  Â  opt.textContent=c;Â 
Â  Â  Â  Â  filter.appendChild(opt);Â 
Â  Â  });Â 
}

// ==== PROMOCODE LOGIC (UNCHANGED) ====
function applyPromo(){
Â  Â  const code=document.getElementById('promoCodeInput').value.trim().toUpperCase();
Â  Â  document.getElementById('promoResult').innerText = ''; // Reset result
Â  Â  Â 
Â  Â  if(!code){ alert("Enter promo code"); return; }
Â  Â  if(cart.length === 0) { alert("Add items to cart first."); return; }

Â  Â  const promo = masterPromocodes.find(p => p.code === code);
Â  Â  Â 
Â  Â  if(!promo){Â 
Â  Â  Â  Â  document.getElementById('promoResult').innerText = "âŒ Invalid promo code.";Â 
Â  Â  Â  Â  appliedPromo = null;
Â  Â  Â  Â  updateCartTotal();
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  Â 
Â  Â  // Check Scope (Global or Vendor Specific)
Â  Â  let isApplicable = true;
Â  Â  if (promo.scope === 'vendor') {
Â  Â  Â  Â  // Check if at least one cart item is from the promo's vendor
Â  Â  Â  Â  const vendorProductsInCart = cart.filter(citem => {
Â  Â  Â  Â  Â  Â  const product = products.find(p => p.id === citem.id);
Â  Â  Â  Â  Â  Â  return product && product.vendorId === promo.vendorId;
Â  Â  Â  Â  });
Â  Â  Â  Â  if (vendorProductsInCart.length === 0) {
Â  Â  Â  Â  Â  Â  isApplicable = false;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  Â 
Â  Â  if (!isApplicable) {
Â  Â  Â  Â  document.getElementById('promoResult').innerText = `âŒ Promo ${code} is only valid for specific products/vendors.`;
Â  Â  Â  Â  appliedPromo = null;
Â  Â  Â  Â  updateCartTotal();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Apply the valid promo
Â  Â  appliedPromo = promo;
Â  Â  updateCartTotal(); // This will recalculate total and check minOrder
}

// ==== CHECKOUT (UNCHANGED) ====
function checkout(){
Â  Â  if(cart.length===0){ alert("Cart empty"); return; }
Â  Â  if(!loggedCustomer){ alert("Login to checkout"); return; }
Â  Â  Â 
Â  Â  let subtotal=cart.reduce((sum,p)=>sum+p.price*(p.quantity||1),0);
Â  Â  let finalTotal = subtotal;
Â  Â  let discount = 0;
Â  Â  Â 
Â  Â  // Final Promo Check
Â  Â  if (appliedPromo) {
Â  Â  Â  Â  Â  Â  if (appliedPromo.minOrder > subtotal) {
Â  Â  Â  Â  Â  Â  Â  Â alert("Checkout failed: Minimum order requirement not met for the applied promo code.");
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (appliedPromo.type === 'percent') {
Â  Â  Â  Â  Â  Â  Â discount = subtotal * (appliedPromo.discount / 100);
Â  Â  Â  Â  } else if (appliedPromo.type === 'fixed') {
Â  Â  Â  Â  Â  Â  Â discount = appliedPromo.discount;
Â  Â  Â  Â  }
Â  Â  Â  Â  finalTotal = subtotal - discount;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  // Update Promocode Usage (for Admin panel tracking)
Â  Â  Â  Â  let usage = JSON.parse(localStorage.getItem("promocodeUsage")||'{}');
Â  Â  Â  Â  usage[appliedPromo.code] = (usage[appliedPromo.code] || 0) + 1;
Â  Â  Â  Â  localStorage.setItem("promocodeUsage", JSON.stringify(usage));
Â  Â  }

Â  Â  // 1. Stock Validation
Â  Â  let outOfStockItems = [];
Â  Â  cart.forEach(citem => {
Â  Â  Â  Â  const p = products.find(pr=>pr.id===citem.id);
Â  Â  Â  Â  if (p && p.stock < citem.quantity) {
Â  Â  Â  Â  Â  Â  outOfStockItems.push(`${p.name} (Available: ${p.stock})`);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  if (outOfStockItems.length > 0) {
Â  Â  Â  Â  alert(`Checkout Failed! Some items are out of stock or quantity exceeds stock:\n- ${outOfStockItems.join('\n- ')}\nPlease adjust your cart.`);
Â  Â  Â  Â  renderAll(); // Re-render to show updated stock
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  Â 
Â  Â  // 2. Update Stock
Â  Â  cart.forEach(citem=>{Â 
Â  Â  Â  Â  const pidx=products.findIndex(pr=>pr.id===citem.id);Â 
Â  Â  Â  Â  if(pidx!==-1){Â 
Â  Â  Â  Â  Â  Â  products[pidx].stock-=citem.quantity||1;Â 
Â  Â  Â  Â  }Â 
Â  Â  });
Â  Â  // Save updated products to localStorage so admin/vendor can see stock change
Â  Â  localStorage.setItem("products",JSON.stringify(products));

Â  Â  // 3. Record Order (Optional but good for prototype)
Â  Â  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
Â  Â  orders.push({
Â  Â  Â  Â  id: orders.length + 1,
Â  Â  Â  Â  customer: loggedCustomer.username,
Â  Â  Â  Â  items: cart,
Â  Â  Â  Â  total: finalTotal.toFixed(2),
Â  Â  Â  Â  discount: discount.toFixed(2),
Â  Â  Â  Â  promocode: appliedPromo ? appliedPromo.code : 'None',
Â  Â  Â  Â  status: 'Pending', // Add status for admin panel
Â  Â  Â  Â  date: new Date().toISOString()
Â  Â  });
Â  Â  localStorage.setItem('orders', JSON.stringify(orders));

Â  Â  // 4. Clear Cart
Â  Â  cart=[];Â 
Â  Â  localStorage.setItem("cart",JSON.stringify(cart));Â 
Â  Â  appliedPromo = null;
Â  Â  document.getElementById('promoResult').innerText = '';
Â  Â  Â 
Â  Â  // 5. Send WhatsApp Message (Final Confirmation)
Â  Â  const orderDetails = cart.map(item => `${item.name} (${item.quantity} units)`).join(', ');
Â  Â  const message = `Order Placed!%0AUser: ${loggedCustomer.username}%0AItems: ${orderDetails}%0ATotal: $${finalTotal.toFixed(2)}%0AAddress: ${loggedCustomer.address}`;
Â  Â  window.open(`https://wa.me/8801XXXXXXXXX?text=${message}`, "_blank");


Â  Â  alert(`Order placed successfully! Final Total: $${finalTotal.toFixed(2)}`);
Â  Â  showPage('home'); // Go back to home
}

// ==== REVIEWS (UNCHANGED) ====
let currentRating = 0;

function renderStarRatingForm() {
Â  Â  const ratingDiv = document.getElementById('ratingStars');
Â  Â  ratingDiv.innerHTML = '';
Â  Â  for (let i = 1; i <= 5; i++) {
Â  Â  Â  Â  const star = document.createElement('span');
Â  Â  Â  Â  star.className = 'star';
Â  Â  Â  Â  star.innerText = 'â˜…';
Â  Â  Â  Â  star.dataset.value = i;
Â  Â  Â  Â  star.onclick = () => { currentRating = i; highlightStars(i); };
Â  Â  Â  Â  ratingDiv.appendChild(star);
Â  Â  }
Â  Â  highlightStars(currentRating);
}

function highlightStars(rating) {
Â  Â  document.querySelectorAll('#ratingStars .star').forEach(star => {
Â  Â  Â  Â  star.style.color = star.dataset.value <= rating ? 'gold' : 'gray';
Â  Â  });
}

function renderReviews() {
Â  Â  const reviewList = document.getElementById('reviewList');
Â  Â  reviewList.innerHTML = '';

Â  Â  if (reviews.length === 0) {
Â  Â  Â  Â  reviewList.innerHTML = '<p style="text-align: center;">No reviews yet. Be the first!</p>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  reviews.slice(-5).reverse().forEach(r => { // Show last 5 reviews
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'review-item';
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  <div>${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5 - r.rating)}</div>
Â  Â  Â  Â  Â  Â  <p>${r.text}</p>
Â  Â  Â  Â  Â  Â  <p class="review-customer">Reviewed by <b>${r.customerName}</b> on ${r.date}</p>
Â  Â  Â  Â  `;
Â  Â  Â  Â  reviewList.appendChild(div);
Â  Â  });
Â  Â  Â 
Â  Â  // Show/hide review form based on login status
Â  Â  if (loggedCustomer) {
Â  Â  Â  Â  document.getElementById('reviewText').style.display = 'block';
Â  Â  Â  Â  document.querySelector('#reviewForm button').style.display = 'block';
Â  Â  Â  Â  document.getElementById('reviewAuthMsg').style.display = 'none';
Â  Â  Â  Â  document.getElementById('ratingStars').style.display = 'block';
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('reviewText').style.display = 'none';
Â  Â  Â  Â  document.querySelector('#reviewForm button').style.display = 'none';
Â  Â  Â  Â  document.getElementById('reviewAuthMsg').style.display = 'block';
Â  Â  Â  Â  document.getElementById('ratingStars').style.display = 'none';
Â  Â  }
}

function submitReview(){Â 
Â  Â  if(!loggedCustomer){ alert("Login to submit review."); return; }
Â  Â  Â 
Â  Â  const text=document.getElementById("reviewText").value.trim();
Â  Â  if(currentRating === 0 || !text){Â 
Â  Â  Â  Â  alert("Please provide a rating (1-5 stars) and review text.");Â 
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â  Â 
Â  Â  reviews.push({
Â  Â  Â  Â  id: reviews.length + 1,
Â  Â  Â  Â  customerName: loggedCustomer.username,
Â  Â  Â  Â  rating: currentRating,
Â  Â  Â  Â  text: text,
Â  Â  Â  Â  date: new Date().toLocaleDateString()
Â  Â  });
Â  Â  localStorage.setItem("reviews",JSON.stringify(reviews));
Â  Â  Â 
Â  Â  document.getElementById("reviewText").value = '';
Â  Â  currentRating = 0;
Â  Â  highlightStars(0);
Â  Â  renderReviews();
Â  Â  alert("Review submitted successfully!");
}


// ==== MISC ====
function openWhatsApp(){Â 
Â  Â  // à¦à¦–à¦¾à¦¨à§‡ à¦†à¦ªà¦¨à¦¾à¦° WhatsApp à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦¦à¦¿à¦¨
Â  Â  window.open("https://wa.me/8801XXXXXXXXX?text=Hello%20Dhamaka%2C%20I%20need%20support%20regarding%20my%20order.", "_blank");Â 
}
</script>
</body>
</html>
